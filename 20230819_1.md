# 株式会社ハートビーツさんから出された課題「lamp環境の構築」の課程6
Apacheの設定なんてすぐ終わるだろうと思っていたが、そんなことなかった。

## Apacheの設定2
前回、急にlocalhostが繋がらなくなるという事態に陥る。
/var/www/htmlの中にファイルを作ってから様子がおかしいので、作成したファイルを一旦削除いてみる。

```
$ sudo rm firstname-hbtask.html
$ sudo rm familyname-hbtask.html
$ ls
index.html
```

再び接続を試みるも失敗。
"接続が拒否されました。"と表示されてしまう。

ファイルの設置が原因ではなさそうだ。ファイル消しちゃった。(バックアップは取ってあるけど)

`https://blog.janjan.net/2021/03/21/windows10-wsl-confirm-apache-connect-localhost/`

```
$ man ip
IP(8)                                                   Linux                                                   IP(8)

NAME
       ip - show / manipulate routing, network devices, interfaces and tunnels

SYNOPSIS
       ip [ OPTIONS ] OBJECT { COMMAND | help }

       ip [ -force ] -batch filename

       OBJECT := { link | address | addrlabel | route | rule | neigh | ntable | tunnel | tuntap | maddress | mroute |
               mrule | monitor | xfrm | netns | l2tp | tcp_metrics | token | macsec | vrf | mptcp | ioam }

       OPTIONS := { -V[ersion] | -h[uman-readable] | -s[tatistics] | -d[etails] | -r[esolve] | -iec | -f[amily] {
               inet | inet6 | link } | -4 | -6 | -B | -0 | -l[oops] { maximum-addr-flush-attempts } | -o[neline] |
               -rc[vbuf] [size] | -t[imestamp] | -ts[hort] | -n[etns] name | -N[umeric] | -a[ll] | -c[olor] |
               -br[ief] | -j[son] | -p[retty] }

OPTIONS
       -V, -Version
              Print the version of the ip utility and exit.

       -h, -human, -human-readable
              output statistics with human readable values followed by suffix.

       -b, -batch <FILENAME>
              Read commands from provided file or standard input and invoke them.  First failure will cause termina‐
              tion of ip.
```

```
$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP group default qlen 1000
    link/ether 00:15:5d:4b:2d:40 brd ff:ff:ff:ff:ff:ff
    inet 192.168.88.8/20 brd 192.168.95.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::215:5dff:fe4b:2d40/64 scope link
       valid_lft forever preferred_lft forever
```

127.0.0.1と192.168.88.8でそれぞれ接続を試みるも失敗。

接続出来なくなる前にしたことって、.NETのアップデートぐらいだが、まさか関係があるなんてことはないよな？

とりあえず、接続できないと表示される画面に「Windowsネットワーク診断ツールを実行する」という表示があったので実行してみた。

> トラブルシューティングが完了しました。　見つかった問題：Webサイトはオンラインですが、接続試行に応答していません。

ufwかWSL側で何かしらをブロックされているのかもしれない。

まずWSL側からいろいろ調べてみる。
'https://learn.microsoft.com/ja-jp/windows/wsl/networking'

ホストマシンのIPアドレスの取得方法が載っているので実行してみる。

```
$ cd /
$ cat /etc/resolv.conf
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateResolvConf = false
nameserver 192.168.**.*
```

念のため一部伏せる。
載っていたコマンドを実行してみたものの、状況は逆である。Linux→Windowsができないのである。


その下の説明は私の知識レベルを超えることが書いてあった。

ufwを停止して接続できるか試してみよう

```
$ sudo ufw disable
Firewall stopped and disabled on system startup
```

ufwを止めたら接続できるようになった。つまり、ufw側の設定を変更する必要がありそうだ。
となると、なぜ昨日は接続できたのだろうか。

```
$ sudo ufw enable
Firewall is active and enabled on system startup
```

再び起動し、接続不可になることを確認

いろいろ探し回って、しばらく時間が経ったら、また繋がるようになった。なにもしていないのに。

'https://learn.microsoft.com/ja-jp/windows/wsl/networking'
'https://qiita.com/kiyokanishiyama/items/cce66507ebc6facde39f'
これらのページを見る限り、また不具合か何かなのかもしれない。

繋がっているうちに、再びファイルを設置

```
$ sudo touch familyname-hbtask.local.html
$ sudo touch firstname-hbtask.local.html
$ sudo vim familyname-hbtask.local.html
$ sudo vim firstname-hbtask.local.html
```

localhostは閲覧できるが、設置したファイルを閲覧できないので、ヒントにあったhostsファイルについて調べてみる。

```
$ ls /etc
PackageKit                     debconf.conf    issue           modules              rc0.d         sudo.conf
X11                            debian_version  issue.net       modules-load.d       rc1.d         sudo_logsrvd.conf
adduser.conf                   default         kernel          mtab                 rc2.d         sudoers
alternatives                   deluser.conf    ld.so.cache     nanorc               rc3.d         sudoers.d
apache2                        depmod.d        ld.so.conf      netconfig            rc4.d         sysctl.conf
apparmor                       dhcp            ld.so.conf.d    netplan              rc5.d         sysctl.d
apparmor.d                     dpkg            ldap            network              rc6.d         systemd
apport                         e2scrub.conf    legal           networkd-dispatcher  rcS.d         terminfo
apt                            environment     libaudit.conf   networks             resolv.conf   timezone
bash.bashrc                    ethertypes      libnl-3         newt                 rmt           tmpfiles.d
bash_completion                firewalld       locale.alias    nftables.conf        rpc           ubuntu-advantage
bash_completion.d              fstab           locale.gen      nsswitch.conf        rsyslog.conf  ucf.conf
bindresvport.blacklist         fuse.conf       localtime       opt                  rsyslog.d     udev
binfmt.d                       gai.conf        logcheck        os-release           screenrc      ufw
byobu                          groff           login.defs      pam.conf             security      update-manager
ca-certificates                group           logrotate.conf  pam.d                selinux       update-motd.d
ca-certificates.conf           group-          logrotate.d     passwd               services      vim
ca-certificates.conf.dpkg-old  gshadow         lsb-release     passwd-              shadow        vtrgb
chrony                         gshadow-        machine-id      perl                 shadow-       wgetrc
console-setup                  gss             magic           pm                   shells        wsl.conf
cron.d                         hdparm.conf     magic.mime      polkit-1             skel          xattr.conf
cron.daily                     host.conf       mailcap         ppp                  ssh           xdg
cron.hourly                    hostname        mailcap.order   profile              ssl           zsh_command_not_found
cron.monthly                   hosts           manpath.config  profile.d            subgid
cron.weekly                    init.d          mime.types      protocols            subgid-
crontab                        inputrc         mke2fs.conf     python3              subuid
dbus-1                         iproute2        modprobe.d      python3.10           subuid-
$ cat /etc/hosts
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateHosts = false
127.0.0.1       localhost
127.0.1.1       DESKTOP-F5G6OIO.        DESKTOP-F5G6OIO
﻿
192.168.0.17    host.docker.internal
192.168.0.17    gateway.docker.internal
127.0.0.1       kubernetes.docker.internal

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```

'https://engineer-ninaritai.com/hosts/'
とりあえず書き込もう。

```
$ sudo vim /etc/hosts
```

適当に編集した。接続を試みたがうまくいかなかった。

