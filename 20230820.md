# 株式会社ハートビーツさんから出された課題「lamp環境の構築」の課程7
数日で終わらせてやる！　と息巻いていたが、早くも7日目になってしまった。

## Apacheの設定3
hostsファイルの設定が上手くいかないので、とりあえずhostsファイルを開いてみる。

```
$ sudo cat /etc/hosts
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateHosts = false
127.0.0.1       localhost
127.0.1.1       DESKTOP-F5G6OIO.        DESKTOP-F5G6OIO
<feff>
192.168.0.17    host.docker.internal
192.168.0.17    gateway.docker.internal
127.0.0.1       kubernetes.docker.internal

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```

あれ？　編集されてない。

```
$ sudo vim /etc/hosts
$ sudo cat /etc/hosts
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateHosts = false
127.0.0.1       localhost
127.0.1.1       DESKTOP-F5G6OIO.        DESKTOP-F5G6OIO
<feff>
192.168.0.17    host.docker.internal
192.168.0.17    gateway.docker.internal
127.0.0.1       kubernetes.docker.internal

102.54.94.97  familyname-hbtask.local.html
38.25.63.10   firstname-hbtask.local.html

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```

htmlをつけたままにしてしまったので、もう一度修正

```
$ sudo vim /etc/hosts
$ sudo cat /etc/hosts
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateHosts = false
127.0.0.1       localhost
127.0.1.1       DESKTOP-F5G6OIO.        DESKTOP-F5G6OIO
<feff>
192.168.0.17    host.docker.internal
192.168.0.17    gateway.docker.internal
127.0.0.1       kubernetes.docker.internal

102.54.94.97  familyname-hbtask.local
38.25.63.10   firstname-hbtask.local

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```

再起動

```
$ exit
PS C:>  wsl --distribution Ubuntu --user <UserName>
```

familyname-hbtask.local
firstname-hbtask.local
2つとも、相変わらず接続できない。

localhostも接続できない。
思いつきで、ufwを再起動。

```
$ ufw disable
$ ufw enable
```

localhostだけは接続できるようになった。

ufwについて調べているとポートを開放するためのコマンドがよ頻繫に紹介されている。
試してみる。

'https://qiita.com/shimakaze_soft/items/c3cce2bfb7d584e1fbce'

```
$ sudo ufw allow 22
$ sudo ufw limit 22
Skipping unsupported IPv4 'limit' rule
Skipping unsupported IPv6 'limit' rule
```

22番ポートはsshのポートらしい。
接続の回数制限をするという'limit'は使えなかった。ローカルでlamp環境を構築するだけなら、設定できなくてもあまり関係ないだろう。

```
$ sudo ufw allow 80
```

'https://www.infraexpert.com/study/tea5.htm'
また、80番はhttpのポートだとも見かけたので、こちらもとりあえず実行してみる。
どーでもいいがこのリンク、最後の"l"がない。なんでだろう。

```
$ sudo vim /etc/hosts
$ sudo cat /etc/hosts
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateHosts = false
127.0.0.1       localhost
127.0.1.1       DESKTOP-F5G6OIO.        DESKTOP-F5G6OIO

102.54.94.97    familyname-hbtask.local
38.25.63.10     firstname-hbtask.local
<feff>
192.168.0.17    host.docker.internal
192.168.0.17    gateway.docker.internal
127.0.0.1       kubernetes.docker.internal

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```
書きこむ位置を変えてみた。

ダメでした。

```
$ sudo ufw disable
$ sudo ufw enable
```

ファイアウォールを再起動してみた。

ダメでした。

`https://okuden-labo.com/hosts-error`
このページにpingコマンドによる確認方法が紹介されていたので、やってみた。

```
$ man ping
PING(8)                                                iputils                                                PING(8)

NAME
       ping - send ICMP ECHO_REQUEST to network hosts

SYNOPSIS
       ping [-aAbBdDfhLnOqrRUvV46] [-c count] [-F flowlabel] [-i interval] [-I interface] [-l preload] [-m mark]
            [-M pmtudisc_option] [-N nodeinfo_option] [-w deadline] [-W timeout] [-p pattern] [-Q tos]
            [-s packetsize] [-S sndbuf] [-t ttl] [-T timestamp option] [hop...] {destination}

DESCRIPTION
       ping uses the ICMP protocol's mandatory ECHO_REQUEST datagram to elicit an ICMP ECHO_RESPONSE from a host or
       gateway. ECHO_REQUEST datagrams (“pings”) have an IP and ICMP header, followed by a struct timeval and then an
       arbitrary number of “pad” bytes used to fill out the packet.

       ping works with both IPv4 and IPv6. Using only one of them explicitly can be enforced by specifying -4 or -6.

       ping can also send IPv6 Node Information Queries (RFC4620). Intermediate hops may not be allowed, because IPv6
       source routing was deprecated (RFC5095).

OPTIONS
       -4
           Use IPv4 only.

       -6
           Use IPv6 only.

       -a
```

```
$ ping familyname-hbtask.local
PING familyname-hbtask.local (102.54.94.97) 56(84) bytes of data.
--- familyname-hbtask.local ping statistics ---
74 packets transmitted, 0 received, 100% packet loss, time 75923ms
```

この結果を見る限り、hostファイルの設定はうまくいっているようだが、パケットが全てロスしているみたい。

'https://www.dot-plus.com/pc/windows/cmd/1292/'
このサイトで登場した"ipconfig"コマンドを試してみる。
```
$ ipconfig
Command 'ipconfig' not found
```
あれ？　と思い、"ipconfig"を入力したあとtabキーを押したら".exe"が追加された。

```
$ ipconfig.exe

Windows IP 構成

Wireless LAN adapter ローカル エリア接続* 3:

   メディアの状態. . . . . . . . . . . .: メディアは接続されていません
   接続固有の DNS サフィックス . . . . .:

Wireless LAN adapter ローカル エリア接続* 12:

   メディアの状態. . . . . . . . . . . .: メディアは接続されていません
   接続固有の DNS サフィックス . . . . .:

イーサネット アダプター vEthernet (WSL):
```
(以下略)

特段問題はなさそうだった。
イーサネット アダプターの欄にIPv4もIPv6も記載があった。

同記事で紹介されていたコマンドも実行してみる。
```
$ ping 8.8.8.8
$ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8) 56(84) bytes of data.
64 bytes from 8.8.8.8: icmp_seq=1 ttl=57 time=37.9 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=57 time=9.25 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=57 time=7.37 ms
64 bytes from 8.8.8.8: icmp_seq=4 ttl=57 time=7.26 ms
64 bytes from 8.8.8.8: icmp_seq=5 ttl=57 time=13.2 ms
^C
--- 8.8.8.8 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4008ms
rtt min/avg/max/mdev = 7.260/14.989/37.850/11.631 ms
```

こちらは問題ないようだ。

また、"apache2.conf"を確認してみる。
```
$ cd /etc/apache2
$ cat apache2.conf
# This is the main Apache server configuration file.  It contains the
# configuration directives that give the server its instructions.
# See http://httpd.apache.org/docs/2.4/ for detailed information about
# the directives and /usr/share/doc/apache2/README.Debian about Debian specific
# hints.
#
#
# Summary of how the Apache 2 configuration works in Debian:
# The Apache 2 web server configuration in Debian is quite different to
# upstream's suggested way to configure the web server. This is because Debian's
# default Apache2 installation attempts to make adding and removing modules,
# virtual hosts, and extra configuration directives as flexible as possible, in
# order to make automating the changes and administering the server as easy as
# possible.

```

(とても長いので以下略)

ながい。全部読んだ。

>  Sets the default security model of the Apache2 HTTPD server. It does not allow access to the root filesystem outside of /usr/share and /var/www. The former is used by web applications packaged in Debian the latter may be used for local directories served by the web server. If your system is serving content from a sub-directory in /srv you must allow access here, or in any related virtual host.

一つ仮説を立てたので、ちょっと試してみる。

```
$ cd /var/www/html
cd ../
$ sudo mv firstname-hbtask.local.html ../
```
wwwの下にファイルを設置しなくてはならないというオチかと思ったら違った。

ダメだった。

"related virtual host"ってなんだ。

```
$ sudo mv firstname-hbtask.local.html /var/www/html
```

諦めて次の課題を見た。
- PHPのバージョンは7系をインストールしてください
- Webブラウザで'http://<自分の名字>-hbtask.local/phpinfo.php'にアクセスすると、phpinfoの情報が表示される

あれ？　スラッシュが入っている。ということは"<自分の名字>-hbtask.local"のディレクトリを作成して、'phpinfo.php'というファイルを作成する必要がありそうだ。

まさかと思い、'http://localhost/firstname-hbtask.local.html'と'http://localhost/familyname-hbtask.local.html'とURLを入れたら接続できた。

となると、今までやろうとしていたこと(ファイル名で要件を満たそうとしたこと)の前提が崩れる。

> Webブラウザで`http://<自分の名字>-hbtask.local/` にアクセスすると「こんにちは。ありがとう。」と表示される

よく課題を見返すと"local"の後ろに/がある。これ知ってる。indexファイルの表示を省略したときのやつだ。

```
$ sudo mkdir firstname-hbtask.local
$ sudo mkdir familyname-hbtask.local
$ sudo touch index.html
$ sudo vim index.html
$ cd ../
$ cd familyname-hbtask.local
$ sudo touch index.html
$ sudo vim index.html
```

先程見返したヒントに

> VirtualHostの機能を利用し、下記の要件を満たしてください

'https://httpd.apache.org/docs/2.4/en/vhosts/examples.html'

公式ドキュメントを見てもVirtualHostを設定するファイルのパスがわからない。

'https://blog.at-human.com/2021/03/ubuntu-apache2-vhostconf/'
VirtualHostの設定について、説明しているサイトを発見した。

VirtualHostを設定するファイルのパスがないのではなく、自分で作らなくてはならないのか。

```
$ cd /etc/apache2
$ ls
apache2.conf    conf-enabled  magic           mods-enabled  sites-available
conf-available  envvars       mods-available  ports.conf    sites-enabled
$ ls sites-enabled
000-default.conf
$ cat sites-available/000-default.conf
<VirtualHost *:80>
        # The ServerName directive sets the request scheme, hostname and port that
        # the server uses to identify itself. This is used when creating
        # redirection URLs. In the context of virtual hosts, the ServerName
        # specifies what hostname must appear in the request's Host: header to
        # match this virtual host. For the default virtual host (this file) this
        # value is not decisive as it is used as a last resort host regardless.
        # However, you must set it for any further virtual host explicitly.
        #ServerName www.example.com

        ServerAdmin webmaster@localhost
        DocumentRoot /var/www/html

        # Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
        # error, crit, alert, emerg.
        # It is also possible to configure the loglevel for particular
        # modules, e.g.
        #LogLevel info ssl:warn

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        # For most configuration files from conf-available/, which are
        # enabled or disabled at a global level, it is possible to
        # include a line for only one particular virtual host. For example the
        # following line enables the CGI configuration for this host only
        # after it has been globally disabled with "a2disconf".
        #Include conf-available/serve-cgi-bin.conf
</VirtualHost>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
```

早速、ファイルを作ろう。

```
$ sudo touch hbtask.conf
$ sudo vim hbtask.conf
```

hbtask.confの中身

```
Listen 80

<VirtualHost 102.54.94.97>
    DocumentRoot "/www/familyname-hbtask.local"
    ServerName familyname-hbtask.local
</VirtualHost>

<VirtualHost 38.25.63.10>
    DocumentRoot "/www/firstname-hbtask.local"
    ServerName firstname-hbtask.local
</VirtualHost>
```

```
$ exit
PS C:>  wsl --distribution Ubuntu --user <UserName>
```

接続できなかった。

```
$ ping familyname-hbtask.local
ping: familyname-hbtask.local: Name or service not known
```

pingの挙動がおかしい。

```
$ sudo vim /etc/hosts
```
何故か再起動前の変更が保存されていなかった。
修正して接続を試みる。

接続できなかった。

```
$ cd /etc/apache2/sites-enabled
$ ls
000-default.conf  hbtask.conf
$ cat hbtask.conf
```
hbtask.confファイルの変更点は無事だった。

それでも接続できなかったので、'https://www.be-webdesigner.com/technotes/server/httpd_conf/virtual_host.htm'このサイトを参考に編集してみる。

```
$ sudo vim hbtask.conf
Listen 80

<VirtualHost *:80>
    DocumentRoot "/www/familyname-hbtask.local"
    ServerName familyname-hbtask.local
</VirtualHost>

<VirtualHost *:80>
    DocumentRoot "/www/firstname-hbtask.local"
    ServerName firstname-hbtask.local
</VirtualHost>
```

```
$ sudo vim /etc/hosts
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateHosts = false
127.0.0.1       localhost       firstname-hbtask.local
127.0.1.1       DESKTOP-F5G6OIO.        DESKTOP-F5G6OIO
127.0.0.2       familyname-hbtask.local
<feff>
192.168.0.17    host.docker.internal
192.168.0.17    gateway.docker.internal
127.0.0.1       kubernetes.docker.internal

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```

接続できないので、apacheの状態を調べる

```
$ sudo systemctl status apache2
× apache2.service - The Apache HTTP Server
     Loaded: loaded (/lib/systemd/system/apache2.service; enabled; vendor preset: enabled)
     Active: failed (Result: exit-code) since Sun 2023-08-20 23:14:34 JST; 23s ago
       Docs: https://httpd.apache.org/docs/2.4/
    Process: 1199 ExecStart=/usr/sbin/apachectl start (code=exited, status=1/FAILURE)

Aug 20 23:14:34 DESKTOP-F5G6OIO systemd[1]: Starting The Apache HTTP Server...
abled; vendor preset: enabled)
 23:14:34 JST; 23s ago

exited, status=1/FAILURE)

che HTTP Server...
ntax error on line 1 of /etc/apache2/sites-enabled/hbtask.conf:
ne multiple Listeners on the same IP:port
rt' failed.
error log may have more information.
 Control process exited, code=exited, status=1/FAILURE
 Failed with result 'exit-code'.
The Apache HTTP Server.
```

hbtask.confのエラーが原因でapacheが停止してしまった。
> error on line 1 of /etc/apache2/sites-enabled/hbtask.conf

一行目は"Listen 80"

> Cannot define multiple Listeners on the same IP:port

試しに"Listen 80"を"NameVirtualHost *:80"に変更してみる。
```
$ sudo vim /etc/apache2/sites-enabled/hbtask.conf
```
ダメだったので元に戻す。

試しにlocalhostの行をコメントアウト
```
$ sudo vim /etc/hosts
```
ダメだったので元に戻す。
```
$ sudo vim /etc/hosts
102.54.94.97    familyname-hbtask.local
102.54.94.97    firstname-hbtask.local

$ sudo vim /etc/apache2/sites-enabled/hbtask.conf
NameVirtualHost 102.54.94.97:80

<VirtualHost 102.54.94.97:80>
    DocumentRoot "/www/familyname-hbtask.local"
    ServerName familyname-hbtask.local
</VirtualHost>

<VirtualHost 102.54.94.97:80>
    DocumentRoot "/www/firstname-hbtask.local"
    ServerName firstname-hbtask.local
</VirtualHost>
```
'https://www.javadrive.jp/apache/virtual/index2.html'これをもとにこうした。

apacheは動かなかった。

もう日付が変わる寸前の時間になってしまった。